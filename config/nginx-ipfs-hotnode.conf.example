# IPFS Hot Node - nginx Configuration
# PRODUCTION CONFIG: /etc/nginx/sites-available/hotipfs-1
# This is the actual production configuration for hotipfs-1.3speak.tv

# Custom log format for IPFS gateway requests
# Tracks: IP, timestamp, request details, status, bytes sent, user agent
log_format ipfs_gateway '$remote_addr - [$time_local] "$request" '
                        '$status $body_bytes_sent "$http_user_agent" '
                        '$request_time';

# ============================================================================
# IPFS Gateway (Public Content Delivery)
# Domain: hotipfs-1.3speak.tv
# This is the main public-facing gateway that serves video content
# ============================================================================

# Rate limit zone (protects gateway abuse)
limit_req_zone $binary_remote_addr zone=ipfs:20m rate=30r/s;

server {
    server_name hotipfs-1.3speak.tv;

    # CRITICAL: Access logging for bandwidth tracking
    access_log /var/log/nginx/ipfs-gateway.log ipfs_gateway;
    error_log /var/log/nginx/ipfs-gateway-error.log;

    # BIG uploads (encoders)
    client_max_body_size 100G;

    # Timeouts for large media
    proxy_connect_timeout 60s;
    proxy_send_timeout 900s;
    proxy_read_timeout 900s;
    send_timeout 900s;

    location / {
        limit_req zone=ipfs burst=200 nodelay;

        proxy_pass http://127.0.0.1:8080;

        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Critical for streaming video
        proxy_buffering off;
        proxy_request_buffering off;

        # Prevent temp file disk abuse
        proxy_max_temp_file_size 0;
    }

    listen 443 ssl;
    ssl_certificate /etc/letsencrypt/live/hotipfs-1.3speak.tv/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/hotipfs-1.3speak.tv/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
}

server {
    if ($host = hotipfs-1.3speak.tv) {
        return 301 https://$host$request_uri;
    }

    listen 80;
    server_name hotipfs-1.3speak.tv;
    return 404;
}

# ============================================================================
# Hot Node Dashboard (Admin Interface)
# Port 3100 - Internal admin panel
# ============================================================================
server {
    listen 3100;
    server_name _;
    
    access_log /var/log/nginx/hotnode-admin.log combined;
    error_log /var/log/nginx/hotnode-admin-error.log;
    
    location / {
        proxy_pass http://127.0.0.1:3101;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_cache_bypass $http_upgrade;
    }
}
