<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Statistics - Hot Node</title>
  <link rel="stylesheet" href="/css/style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <nav class="navbar">
    <div class="container">
      <div class="nav-brand">
        <h1>üî• <%= config.hotnode.name %></h1>
      </div>
      <ul class="nav-links">
        <li><a href="/">Dashboard</a></li>
        <li><a href="/pins">Pins</a></li>
        <li><a href="/stats" class="active">Stats</a></li>
        <li><a href="/settings">Settings</a></li>
        <li class="auth-section">
          <button id="loginBtn" class="btn btn-sm btn-secondary" style="display: <%= isAuthenticated ? 'none' : 'inline-block' %>;">
            üîí Login
          </button>
          <button id="logoutBtn" class="btn btn-sm btn-secondary" style="display: <%= isAuthenticated ? 'inline-block' : 'none' %>;">
            üîì Logout
          </button>
        </li>
      </ul>
    </div>
  </nav>

  <main class="container">
    <h2>System Statistics</h2>

    <!-- Summary Cards -->
    <div class="stats-grid" style="margin-bottom: 2rem;">
      <div class="stat-card">
        <div class="stat-icon">üìä</div>
        <div class="stat-info">
          <div class="stat-label">Total Pins</div>
          <div class="stat-value" id="totalPins">-</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üì§</div>
        <div class="stat-info">
          <div class="stat-label">Pins Served (90d)</div>
          <div class="stat-value" id="pinsServed">-</div>
          <div class="stat-subtext" id="bytesServed">-</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üîÑ</div>
        <div class="stat-info">
          <div class="stat-label">Migrated (90d)</div>
          <div class="stat-value" id="migrated90">-</div>
          <div class="stat-subtext" id="migratedBytes">-</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üóëÔ∏è</div>
        <div class="stat-info">
          <div class="stat-label">Storage Freed (90d)</div>
          <div class="stat-value" id="storageFreed">-</div>
        </div>
      </div>
    </div>

    <!-- Period Selector Tabs -->
    <div class="card">
      <div class="tabs">
        <button class="tab-btn active" data-period="7">7 Days</button>
        <button class="tab-btn" data-period="30">30 Days</button>
        <button class="tab-btn" data-period="90">90 Days</button>
      </div>
    </div>

    <!-- Migration Stats -->
    <div class="card">
      <h3>üì¶ Migration Statistics</h3>
      <div class="stats-row" id="migrationStats">
        <div class="stat-item">
          <div class="stat-item-label">Successful</div>
          <div class="stat-item-value success-text" id="migrationSuccess">-</div>
        </div>
        <div class="stat-item">
          <div class="stat-item-label">Failed</div>
          <div class="stat-item-value danger-text" id="migrationFailures">-</div>
        </div>
        <div class="stat-item">
          <div class="stat-item-label">Max Retries Reached</div>
          <div class="stat-item-value warning-text" id="migrationMaxRetries">-</div>
        </div>
        <div class="stat-item">
          <div class="stat-item-label">Data Migrated</div>
          <div class="stat-item-value" id="migrationBytes">-</div>
        </div>
      </div>
    </div>

    <!-- Cleanup Stats -->
    <div class="card">
      <h3>üßπ Cleanup & Garbage Collection</h3>
      <div class="stats-row" id="cleanupStats">
        <div class="stat-item">
          <div class="stat-item-label">Invalid Pins Removed</div>
          <div class="stat-item-value" id="cleanupInvalid">-</div>
        </div>
        <div class="stat-item">
          <div class="stat-item-label">Migrated Unpinned</div>
          <div class="stat-item-value" id="cleanupMigrated">-</div>
        </div>
        <div class="stat-item">
          <div class="stat-item-label">GC Runs</div>
          <div class="stat-item-value" id="gcRuns">-</div>
        </div>
        <div class="stat-item">
          <div class="stat-item-label">Storage Freed by GC</div>
          <div class="stat-item-value" id="gcFreed">-</div>
        </div>
      </div>
    </div>

    <!-- System Metrics -->
    <div class="card">
      <h3>üíª System Metrics (Last Hour Average)</h3>
      <div class="stats-row" id="systemMetrics">
        <div class="stat-item">
          <div class="stat-item-label">CPU Usage</div>
          <div class="stat-item-value" id="cpuAvg">-</div>
        </div>
        <div class="stat-item">
          <div class="stat-item-label">CPU Peak</div>
          <div class="stat-item-value" id="cpuMax">-</div>
        </div>
        <div class="stat-item">
          <div class="stat-item-label">Memory Usage</div>
          <div class="stat-item-value" id="memoryAvg">-</div>
        </div>
        <div class="stat-item">
          <div class="stat-item-label">Disk Usage</div>
          <div class="stat-item-value" id="diskAvg">-</div>
        </div>
      </div>
    </div>

    <!-- Bandwidth Chart (existing) -->
    <div class="card">
      <h3>üìà Bandwidth Usage</h3>
      <div style="margin-bottom: 1rem;">
        <a href="/stats?period=hourly" class="btn <%= period === 'hourly' ? 'btn-primary' : 'btn-secondary' %> btn-sm">Hourly</a>
        <a href="/stats?period=daily" class="btn <%= period === 'daily' ? 'btn-primary' : 'btn-secondary' %> btn-sm">Daily</a>
        <a href="/stats?period=weekly" class="btn <%= period === 'weekly' ? 'btn-primary' : 'btn-secondary' %> btn-sm">Weekly</a>
        <a href="/stats?period=monthly" class="btn <%= period === 'monthly' ? 'btn-primary' : 'btn-secondary' %> btn-sm">Monthly</a>
      </div>
      <canvas id="bandwidthChart"></canvas>
    </div>

    <!-- Detailed Stats Table (existing) -->
    <div class="card">
      <h3>Detailed Traffic Stats</h3>
      <div class="table-responsive">
        <table class="data-table">
          <thead>
            <tr>
              <th>Timestamp</th>
              <th>Bytes In</th>
              <th>Bytes Out</th>
              <th>Requests</th>
            </tr>
          </thead>
          <tbody>
            <% if (stats && stats.length > 0) { %>
              <% stats.forEach(stat => { %>
                <tr>
                  <td><%= new Date(stat.timestamp).toLocaleString() %></td>
                  <td><%= (stat.bytes_in / (1024 * 1024)).toFixed(2) %> MB</td>
                  <td><%= (stat.bytes_out / (1024 * 1024)).toFixed(2) %> MB</td>
                  <td><%= stat.requests_count || 0 %></td>
                </tr>
              <% }); %>
            <% } else { %>
              <tr>
                <td colspan="4" class="text-center">No statistics available</td>
              </tr>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <footer>
    <div class="container">
      <p>&copy; 2026 IPFS Hot Node Service v1.0.0</p>
    </div>
  </footer>

  <!-- Login Modal -->
  <div id="loginModal" class="modal" style="display: none;">
    <div class="modal-content">
      <h3>Admin Login</h3>
      <form id="loginForm">
        <input 
          type="password" 
          id="loginPassword" 
          placeholder="Enter admin password" 
          required 
          autocomplete="current-password"
        >
        <div class="modal-buttons">
          <button type="submit" class="btn btn-primary">Login</button>
          <button type="button" class="btn btn-secondary" onclick="hideLoginModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="/js/main.js"></script>
  <script>
    // State management - separate periods for different sections
    let summaryPeriod = 7; // For the new stats (7/30/90 days)
    let summaryData = null;

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', async () => {
      await loadSummaryData();
      updateDisplayedStats();
      
      // Setup tab handlers for 7/30/90 day stats
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          e.target.classList.add('active');
          summaryPeriod = parseInt(e.target.dataset.period);
          updateDisplayedStats();
        });
      });
    });

    // Load summary data from API
    async function loadSummaryData() {
      try {
        const response = await fetch('/api/stats/summary/all');
        summaryData = await response.json();
      } catch (error) {
        console.error('Failed to load summary data:', error);
        // Set empty data structure to prevent errors
        summaryData = {
          pins: { total: 0, migrated: 0 },
          migration: { days_7: {}, days_30: {}, days_90: { success: 0, bytes_migrated: 0 } },
          cleanup: { days_7: {}, days_30: {}, days_90: {} },
          system: { cpu_avg: 0, cpu_max: 0, memory_avg: 0, disk_avg: 0 }
        };
      }
    }

    // Update displayed stats based on selected period (7/30/90 days)
    function updateDisplayedStats() {
      if (!summaryData) return;

      const periodKey = `days_${summaryPeriod}`;
      
      // Update summary cards (always use 90-day stats)
      document.getElementById('totalPins').textContent = (summaryData.pins?.total || 0).toLocaleString();
      document.getElementById('pinsServed').textContent = (summaryData.pins?.migrated || 0).toLocaleString();
      document.getElementById('bytesServed').textContent = formatBytes(summaryData.migration?.days_90?.bytes_migrated || 0);
      
      document.getElementById('migrated90').textContent = (summaryData.migration?.days_90?.success || 0).toLocaleString();
      document.getElementById('migratedBytes').textContent = formatBytes(summaryData.migration?.days_90?.bytes_migrated || 0);
      
      const cleanup90 = summaryData.cleanup?.days_90 || {};
      const totalFreed = (cleanup90.bytes_freed_invalid || 0) + 
                         (cleanup90.bytes_freed_migrated || 0) + 
                         (cleanup90.gc_bytes_freed || 0);
      document.getElementById('storageFreed').textContent = formatBytes(totalFreed);
      
      // Update migration stats for selected period (7/30/90)
      const migration = summaryData.migration?.[periodKey] || {};
      document.getElementById('migrationSuccess').textContent = (migration.success || 0).toLocaleString();
      document.getElementById('migrationFailures').textContent = (migration.failures || 0).toLocaleString();
      document.getElementById('migrationMaxRetries').textContent = (migration.max_retries || 0).toLocaleString();
      document.getElementById('migrationBytes').textContent = formatBytes(migration.bytes_migrated || 0);
      
      // Update cleanup stats for selected period (7/30/90)
      const cleanup = summaryData.cleanup?.[periodKey] || {};
      document.getElementById('cleanupInvalid').textContent = (cleanup.invalid_removed || 0).toLocaleString();
      document.getElementById('cleanupMigrated').textContent = (cleanup.migrated_unpinned || 0).toLocaleString();
      document.getElementById('gcRuns').textContent = (cleanup.gc_runs || 0).toLocaleString();
      document.getElementById('gcFreed').textContent = formatBytes(cleanup.gc_bytes_freed || 0);
      
      // Update system metrics
      const system = summaryData.system || {};
      document.getElementById('cpuAvg').textContent = (system.cpu_avg || 0).toFixed(1) + '%';
      document.getElementById('cpuMax').textContent = (system.cpu_max || 0).toFixed(1) + '%';
      document.getElementById('memoryAvg').textContent = (system.memory_avg || 0).toFixed(1) + '%';
      document.getElementById('diskAvg').textContent = (system.disk_avg || 0).toFixed(1) + '%';
    }

    // Format bytes to human-readable format
    function formatBytes(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Existing bandwidth chart code - uses separate period (hourly/daily/weekly/monthly from URL)
    const stats = <%= JSON.stringify(stats || []) %>;
    const labels = stats.map(s => new Date(s.timestamp).toLocaleString());
    const bytesIn = stats.map(s => s.bytes_in / (1024 * 1024));
    const bytesOut = stats.map(s => s.bytes_out / (1024 * 1024));

    const ctx = document.getElementById('bandwidthChart').getContext('2d');
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'Bytes In (MB)',
          data: bytesIn,
          borderColor: 'rgb(75, 192, 192)',
          backgroundColor: 'rgba(75, 192, 192, 0.2)',
          tension: 0.1
        }, {
          label: 'Bytes Out (MB)',
          data: bytesOut,
          borderColor: 'rgb(255, 99, 132)',
          backgroundColor: 'rgba(255, 99, 132, 0.2)',
          tension: 0.1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          title: {
            display: true,
            text: 'Bandwidth Usage Over Time'
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'MB'
            }
          }
        }
      }
    });
  </script>
</body>
</html>
