<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pin Management - Hot Node</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <nav class="navbar">
    <div class="container">
      <div class="nav-brand">
        <h1>üî• <%= config.hotnode.name %></h1>
      </div>
      <ul class="nav-links">
        <li><a href="/">Dashboard</a></li>
        <li><a href="/pins" class="active">Pins</a></li>
        <li><a href="/stats">Stats</a></li>
        <li><a href="/settings">Settings</a></li>
        <li class="auth-section">
          <button id="loginBtn" class="btn btn-sm btn-secondary" style="display: <%= isAuthenticated ? 'none' : 'inline-block' %>;">
            üîí Login
          </button>
          <button id="logoutBtn" class="btn btn-sm btn-secondary" style="display: <%= isAuthenticated ? 'inline-block' : 'none' %>;">
            üîì Logout
          </button>
        </li>
      </ul>
    </div>
  </nav>

  <main class="container">
    <h2>Pin Management</h2>

    <!-- Filters -->
    <div class="card">
      <form method="GET" action="/pins" class="filter-form">
        <div class="form-group">
          <label>Status:</label>
          <select name="status">
            <option value="">All</option>
            <option value="pending" <%= filters.status === 'pending' ? 'selected' : '' %>>Pending</option>
            <option value="valid" <%= filters.status === 'valid' ? 'selected' : '' %>>Valid</option>
            <option value="invalid" <%= filters.status === 'invalid' ? 'selected' : '' %>>Invalid</option>
          </select>
        </div>
        <div class="form-group">
          <label>Search CID:</label>
          <input type="text" name="search" value="<%= filters.search || '' %>" placeholder="Enter CID...">
        </div>
        <button type="submit" class="btn btn-primary">Filter</button>
        <a href="/pins" class="btn btn-secondary">Clear</a>
      </form>
    </div>

    <!-- Pins Table -->
    <div class="card">
      <div class="table-responsive">
        <table class="data-table">
          <thead>
            <tr>
              <th>CID</th>
              <th>Status</th>
              <th>Size</th>
              <th>Added</th>
              <th>Migrated</th>
              <th>Supernode</th>
              <th>Retries</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% if (pins && pins.length > 0) { %>
              <% pins.forEach(pin => { %>
                <tr data-cid="<%= pin.cid %>">
                  <td><code class="cid" title="<%= pin.cid %>"><%= pin.cid.substring(0, 20) %>...</code></td>
                  <td><span class="badge badge-<%= pin.status %>"><%= pin.status %></span></td>
                  <td><%= pin.size_bytes ? (pin.size_bytes / (1024 * 1024)).toFixed(2) + ' MB' : 'N/A' %></td>
                  <td><%= new Date(pin.added_at).toLocaleString() %></td>
                  <td><%= pin.migrated ? '‚úì ' + new Date(pin.migrated_at).toLocaleDateString() : '‚óã' %></td>
                  <td>
                    <span class="supernode-status" data-cid="<%= pin.cid %>">
                      <button class="btn btn-sm btn-info" onclick="checkSupernode('<%= pin.cid %>')">Check</button>
                    </span>
                  </td>
                  <td><%= pin.retry_count || 0 %></td>
                  <td>
                    <% if (!pin.unpinned) { %>
                      <button class="btn btn-sm btn-danger unpin-btn" data-cid="<%= pin.cid %>" onclick="unpinCID('<%= pin.cid %>')" <%= pin.migrated ? '' : 'disabled' %>>Unpin</button>
                    <% } %>
                  </td>
                </tr>
              <% }); %>
            <% } else { %>
              <tr>
                <td colspan="7" class="text-center">No pins found</td>
              </tr>
            <% } %>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <% if (pagination.totalPages > 1) { %>
        <div class="pagination">
          <% if (pagination.page > 1) { %>
            <a href="?page=<%= pagination.page - 1 %>&status=<%= filters.status || '' %>&search=<%= filters.search || '' %>" class="btn btn-sm">Previous</a>
          <% } %>
          
          <span>Page <%= pagination.page %> of <%= pagination.totalPages %> (<%= pagination.totalPins %> total)</span>
          
          <% if (pagination.page < pagination.totalPages) { %>
            <a href="?page=<%= pagination.page + 1 %>&status=<%= filters.status || '' %>&search=<%= filters.search || '' %>" class="btn btn-sm">Next</a>
          <% } %>
        </div>
      <% } %>
    </div>

    <!-- Manual Pin Add -->
    <div class="card">
      <h3>Manual Pin Add</h3>
      <p class="info-text" style="margin-bottom: 1rem; color: #666;">
        ‚è±Ô∏è Note: Pinning can take up to 5 minutes if the content needs to be fetched from the IPFS network. 
        If the CID doesn't exist or is unreachable, the operation will timeout.
      </p>
      <form id="addPinForm" class="form-inline">
        <input type="text" id="cidInput" placeholder="Enter CID (e.g., QmXxx...)" required style="flex: 1; min-width: 400px;">
        <button type="submit" class="btn btn-primary">Add Pin</button>
      </form>
    </div>

    <!-- Scan Logs for Pins -->
    <div class="card">
      <h3>Discover Pins from IPFS</h3>
      <p class="info-text" style="margin-bottom: 1rem; color: #666;">
        üîç Scan IPFS for all current pins and add any missing ones to the database.
        Useful for discovering encoder uploads that aren't tracked yet.
      </p>
      <button id="scanLogsBtn" class="btn btn-info">Scan IPFS for Pins</button>
      <div id="scanResults" style="margin-top: 1rem; display: none;"></div>
    </div>

    <!-- Admin Actions (only visible when authenticated) -->
    <div class="card" id="adminActionsCard" style="display: <%= isAuthenticated ? 'block' : 'none' %>;">
      <h3>üîß Admin Actions</h3>
      <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: flex-start;">
        <div style="flex: 1; min-width: 250px;">
          <h4 style="margin-bottom: 0.5rem;">Validate Pending Pins</h4>
          <p class="info-text" style="margin-bottom: 0.5rem; color: #666; font-size: 0.9rem;">
            Validate pending pins against MongoDB to verify they are legitimate encoder uploads.
          </p>
          <button id="validatePinsBtn" class="btn btn-warning">Run MongoDB Validator</button>
        </div>
        <div style="flex: 1; min-width: 250px;">
          <h4 style="margin-bottom: 0.5rem;">Garbage Collection</h4>
          <p class="info-text" style="margin-bottom: 0.5rem; color: #666; font-size: 0.9rem;">
            Run IPFS garbage collection to free up disk space by removing unpinned blocks.
          </p>
          <button id="runGcBtn" class="btn btn-danger">Run GC</button>
        </div>
      </div>
      <div id="adminActionResults" style="margin-top: 1rem; display: none;"></div>
    </div>
  </main>

  <footer>
    <div class="container">
      <p>&copy; 2026 IPFS Hot Node Service v1.0.0</p>
    </div>
  </footer>

  <!-- Login Modal -->
  <div id="loginModal" class="modal" style="display: none;">
    <div class="modal-content">
      <h3>Admin Login</h3>
      <form id="loginForm">
        <input 
          type="password" 
          id="loginPassword" 
          placeholder="Enter admin password" 
          required 
          autocomplete="current-password"
        >
        <div class="modal-buttons">
          <button type="submit" class="btn btn-primary">Login</button>
          <button type="button" class="btn btn-secondary" onclick="hideLoginModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script src="/js/main.js"></script>
  <script>
    async function checkSupernode(cid) {
      const statusCell = document.querySelector(`.supernode-status[data-cid="${cid}"]`);
      const row = document.querySelector(`tr[data-cid="${cid}"]`);
      const unpinBtn = row.querySelector('.unpin-btn');
      
      // Show loading
      statusCell.innerHTML = '<span style="color: #666;">Checking...</span>';
      
      try {
        const response = await fetch('/api/pins/check-supernode', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ cid })
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
          if (data.exists) {
            // Pin exists on supernode
            statusCell.innerHTML = '<span style="color: #22c55e; font-weight: bold;">‚úì On Supernode</span>';
            
            // Enable unpin button
            if (unpinBtn) {
              unpinBtn.disabled = false;
            }
            
            // Ask if they want to mark as migrated
            if (confirm('This pin exists on the supernode. Mark as migrated?\n\nThis will keep it on your hot node for the retention period (7 days from when it was added), giving temporary boost to delivery.')) {
              await markAsMigrated(cid);
            }
          } else {
            // Pin doesn't exist on supernode
            statusCell.innerHTML = '<span style="color: #ef4444;">‚úó Not on Supernode</span>';
            showNotification('Pin not found on supernode', 'info');
          }
        } else {
          throw new Error(data.message || 'Failed to check supernode');
        }
      } catch (error) {
        statusCell.innerHTML = '<button class="btn btn-sm btn-info" onclick="checkSupernode(\'' + cid + '\')">Check</button>';
        showNotification('‚úó Error checking supernode: ' + error.message, 'error');
      }
    }
    
    async function markAsMigrated(cid) {
      try {
        const response = await fetch('/api/pins/mark-migrated', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ cid })
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
          showNotification('‚úì Marked as migrated!', 'success');
          setTimeout(() => location.reload(), 1500);
        } else {
          throw new Error(data.message || 'Failed to mark as migrated');
        }
      } catch (error) {
        showNotification('‚úó Error: ' + error.message, 'error');
      }
    }

    async function unpinCID(cid) {
      if (!confirm(`Are you sure you want to unpin ${cid}?`)) return;
      
      try {
        const response = await fetch('/api/pins/remove', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ cid })
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
          showNotification('‚úì Pin removed successfully!', 'success');
          setTimeout(() => location.reload(), 1500);
        } else {
          const errorMsg = data.message || data.error || 'Unknown error occurred';
          showNotification('‚úó Failed to remove pin: ' + errorMsg, 'error');
        }
      } catch (error) {
        showNotification('‚úó Network error: ' + error.message, 'error');
      }
    }

    document.getElementById('addPinForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const cid = document.getElementById('cidInput').value.trim();
      
      if (!cid) {
        showNotification('Please enter a CID', 'error');
        return;
      }
      
      // Disable form while processing
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.disabled = true;
      submitBtn.textContent = 'Adding pin...';
      
      try {
        const response = await fetch('/api/pins/add', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ cid })
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
          showNotification('‚úì Pin added successfully!', 'success');
          document.getElementById('cidInput').value = '';
          setTimeout(() => location.reload(), 1500);
        } else {
          // Show the actual error message from the API
          const errorMsg = data.message || data.error || 'Unknown error occurred';
          showNotification('‚úó Failed to add pin: ' + errorMsg, 'error');
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        }
      } catch (error) {
        showNotification('‚úó Network error: ' + error.message, 'error');
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      }
    });

    document.getElementById('scanLogsBtn').addEventListener('click', async () => {
      const btn = document.getElementById('scanLogsBtn');
      const resultsDiv = document.getElementById('scanResults');
      
      btn.disabled = true;
      btn.textContent = 'Scanning IPFS...';
      resultsDiv.style.display = 'none';
      
      try {
        const response = await fetch('/api/pins/scan-logs', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
          resultsDiv.innerHTML = `
            <div style="padding: 1rem; background: #f0f9ff; border-left: 4px solid #3b82f6; border-radius: 4px;">
              <strong>Scan Complete:</strong><br>
              üìä Scanned: ${data.scanned} pins in IPFS<br>
              ‚úÖ Added: ${data.added} new pins<br>
              ‚ÑπÔ∏è Already tracked: ${data.alreadyExists} pins<br>
              ${data.errors && data.errors.length > 0 ? `<br>‚ö†Ô∏è Errors: ${data.errors.length}` : ''}
            </div>
          `;
          resultsDiv.style.display = 'block';
          
          if (data.added > 0) {
            showNotification(`‚úì Added ${data.added} new pins from IPFS!`, 'success');
            setTimeout(() => location.reload(), 2000);
          } else {
            showNotification('No new pins found', 'info');
          }
        } else {
          throw new Error(data.message || 'Scan failed');
        }
      } catch (error) {
        resultsDiv.innerHTML = `
          <div style="padding: 1rem; background: #fef2f2; border-left: 4px solid #ef4444; border-radius: 4px;">
            <strong>‚ùå Error:</strong> ${error.message}
          </div>
        `;
        resultsDiv.style.display = 'block';
        showNotification('‚úó Scan failed: ' + error.message, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Scan IPFS for Pins';
      }
    });

    // MongoDB Validator button handler
    document.getElementById('validatePinsBtn')?.addEventListener('click', async () => {
      const btn = document.getElementById('validatePinsBtn');
      const resultsDiv = document.getElementById('adminActionResults');
      
      btn.disabled = true;
      btn.textContent = 'Validating...';
      
      try {
        const response = await fetch('/api/validators/mongo', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
          resultsDiv.innerHTML = `
            <div style="padding: 1rem; background: #f0fdf4; border-left: 4px solid #22c55e; border-radius: 4px;">
              <strong>‚úÖ MongoDB Validation Started</strong><br>
              The validator is running in the background. Check logs for progress.
            </div>
          `;
          resultsDiv.style.display = 'block';
          showNotification('‚úì MongoDB validation started!', 'success');
        } else {
          throw new Error(data.message || data.error || 'Validation failed');
        }
      } catch (error) {
        resultsDiv.innerHTML = `
          <div style="padding: 1rem; background: #fef2f2; border-left: 4px solid #ef4444; border-radius: 4px;">
            <strong>‚ùå Error:</strong> ${error.message}
          </div>
        `;
        resultsDiv.style.display = 'block';
        showNotification('‚úó Validation failed: ' + error.message, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Run MongoDB Validator';
      }
    });

    // Garbage Collection button handler
    document.getElementById('runGcBtn')?.addEventListener('click', async () => {
      if (!confirm('Run garbage collection? This will remove unpinned blocks from IPFS to free disk space.')) {
        return;
      }
      
      const btn = document.getElementById('runGcBtn');
      const resultsDiv = document.getElementById('adminActionResults');
      
      btn.disabled = true;
      btn.textContent = 'Running GC...';
      
      try {
        const response = await fetch('/api/gc/run', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
          resultsDiv.innerHTML = `
            <div style="padding: 1rem; background: #f0fdf4; border-left: 4px solid #22c55e; border-radius: 4px;">
              <strong>üóëÔ∏è Garbage Collection Started</strong><br>
              GC is running in the background. This may take several minutes. Check logs for progress.
            </div>
          `;
          resultsDiv.style.display = 'block';
          showNotification('‚úì Garbage collection started!', 'success');
        } else {
          throw new Error(data.message || data.error || 'GC failed');
        }
      } catch (error) {
        resultsDiv.innerHTML = `
          <div style="padding: 1rem; background: #fef2f2; border-left: 4px solid #ef4444; border-radius: 4px;">
            <strong>‚ùå Error:</strong> ${error.message}
          </div>
        `;
        resultsDiv.style.display = 'block';
        showNotification('‚úó GC failed: ' + error.message, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Run GC';
      }
    });
  </script>
</body>
</html>
